<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QA Flow</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 600px; margin: 2rem auto; padding: 1rem; }
    .question { margin-bottom: 1.5rem; border: 1px solid #ddd; padding: 1rem; border-radius: 8px; }
    .header { font-size: 0.75rem; background: #e0e0e0; padding: 2px 8px; border-radius: 4px; display: inline-block; margin-bottom: 0.5rem; }
    .question-text { font-weight: 600; margin-bottom: 0.75rem; }
    .option { margin: 0.5rem 0; }
    .option label { cursor: pointer; }
    .option-desc { font-size: 0.85rem; color: #666; margin-left: 1.5rem; }
    .other-input { margin-left: 1.5rem; margin-top: 0.25rem; width: calc(100% - 2rem); }
    button { background: #007bff; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer; font-size: 1rem; }
    button:hover { background: #0056b3; }
  </style>
</head>
<body>
  <div id="questions-container"></div>
  <button onclick="submitAnswers()">Send</button>

  <script>
    // Configuration
    const MCP_ENDPOINT = "http://localhost:3000/mcp";
    const ARTIFACT_ID = "{{ARTIFACT_ID}}";

    // Questions loaded from server
    let QUESTIONS_DATA = [];

    // MCP Client
    let sessionId = null;

    async function mcpRequest(method, params = {}) {
      const headers = {
        "Content-Type": "application/json",
        "Accept": "application/json, text/event-stream"
      };

      if (sessionId) {
        headers["Mcp-Session-Id"] = sessionId;
      }

      const response = await fetch(MCP_ENDPOINT, {
        method: "POST",
        headers,
        body: JSON.stringify({
          jsonrpc: "2.0",
          id: Date.now(),
          method,
          params
        })
      });

      const newSessionId = response.headers.get("Mcp-Session-Id");
      if (newSessionId) {
        sessionId = newSessionId;
      }

      const contentType = response.headers.get("Content-Type") || "";

      if (contentType.includes("text/event-stream")) {
        // Parse SSE response
        const text = await response.text();
        const lines = text.split("\n");
        for (const line of lines) {
          if (line.startsWith("data: ")) {
            const data = line.slice(6);
            if (data && data !== "[DONE]") {
              return JSON.parse(data);
            }
          }
        }
        throw new Error("No data in SSE response");
      }

      return response.json();
    }

    async function mcpInitialize() {
      return mcpRequest("initialize", {
        protocolVersion: "2025-03-26",
        clientInfo: { name: "qa-flow-client", version: "1.0.0" },
        capabilities: {}
      });
    }

    async function mcpCallTool(name, args) {
      return mcpRequest("tools/call", { name, arguments: args });
    }

    // UI Rendering
    function renderQuestions() {
      const container = document.getElementById('questions-container');
      container.innerHTML = QUESTIONS_DATA.map((q, qIdx) => `
        <div class="question" data-idx="${qIdx}" data-multi="${q.multiSelect}">
          <span class="header">${q.header}</span>
          <div class="question-text">${q.question}</div>
          ${q.options.map((opt, oIdx) => `
            <div class="option">
              <label>
                <input type="${q.multiSelect ? 'checkbox' : 'radio'}"
                       name="q${qIdx}" value="${opt.label}">
                ${opt.label}
              </label>
              <div class="option-desc">${opt.description}</div>
            </div>
          `).join('')}
          <div class="option">
            <label>
              <input type="${q.multiSelect ? 'checkbox' : 'radio'}"
                     name="q${qIdx}" value="__other__">
              Other
            </label>
            <input type="text" class="other-input" placeholder="Enter custom answer..."
                   style="display:none" data-q="${qIdx}">
          </div>
        </div>
      `).join('');

      document.querySelectorAll('input[value="__other__"]').forEach(el => {
        el.addEventListener('change', (e) => {
          const input = document.querySelector(`.other-input[data-q="${e.target.name.slice(1)}"]`);
          input.style.display = e.target.checked ? 'block' : 'none';
        });
      });
    }

    function collectAnswers() {
      const answers = {};
      document.querySelectorAll('.question').forEach((qEl) => {
        const idx = qEl.dataset.idx;
        const isMulti = qEl.dataset.multi === 'true';
        const selected = Array.from(qEl.querySelectorAll('input:checked')).map(i => {
          if (i.value === '__other__') {
            return qEl.querySelector(`.other-input[data-q="${idx}"]`).value;
          }
          return i.value;
        });
        answers[`q${idx}`] = isMulti ? selected : selected[0] || null;
      });
      return answers;
    }

    async function submitAnswers() {
      const answers = collectAnswers();
      console.log('Collected answers:', answers);

      try {
        await mcpInitialize();
        const result = await mcpCallTool("qa_submit", {
          artifact_id: ARTIFACT_ID,
          answers: answers
        });
        console.log('MCP response:', result);
        alert('Answers submitted successfully!');
      } catch (err) {
        console.error('MCP error:', err);
        alert('Failed to submit: ' + err.message);
      }
    }

    async function loadQuestions() {
      try {
        document.getElementById('questions-container').innerHTML = '<p>Loading questions...</p>';
        await mcpInitialize();
        const result = await mcpCallTool("qa_get_questions", { artifact_id: ARTIFACT_ID });
        QUESTIONS_DATA = result.result.content[0].text
          ? JSON.parse(result.result.content[0].text).questions
          : result.result.structuredContent?.questions || [];
        renderQuestions();
      } catch (err) {
        console.error('Failed to load questions:', err);
        document.getElementById('questions-container').innerHTML =
          '<p style="color:red">Failed to load questions: ' + err.message + '</p>';
      }
    }

    loadQuestions();
  </script>
</body>
</html>
